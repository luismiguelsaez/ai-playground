---
# Tasks for ssh-tunnel-and-watchdog role

- name: Install required packages
  ansible.builtin.apt:
    name:
      - autossh
      - watchdog
    state: present
    update_cache: yes

- name: Copy Systemd unit file for ssh-tunnel
  ansible.builtin.template:
    src: ssh-tunnel.service.j2
    dest: /etc/systemd/system/ssh-tunnel.service
    mode: '0644'
  notify: Restart ssh-tunnel service

- name: Enable and start ssh-tunnel service
  ansible.builtin.systemd:
    name: ssh-tunnel
    enabled: yes
    state: started
    daemon_reload: yes

- name: Configure watchdog daemon
  ansible.builtin.template:
    src: watchdog.conf.j2
    dest: /etc/watchdog.conf
    mode: '0644'
  notify: Restart watchdog service

- name: Enable and start watchdog service
  ansible.builtin.systemd:
    name: watchdog
    enabled: yes
    state: started

- name: Copy timer file for scheduled-reboot
  ansible.builtin.template:
    src: scheduled-reboot.timer.j2
    dest: /etc/systemd/system/scheduled-reboot.timer
    mode: '0644'
  notify: Reload systemd

- name: Copy service file for scheduled-reboot
  ansible.builtin.template:
    src: scheduled-reboot.service.j2
    dest: /etc/systemd/system/scheduled-reboot.service
    mode: '0644'

- name: Enable and start scheduled-reboot timer
  ansible.builtin.systemd:
    name: scheduled-reboot.timer
    enabled: yes
    state: started

- name: Copy SSH public key for tunnel user (if needed)
  ansible.builtin.copy:
    content: "{{ lookup('file', ssh_tunnel_public_key_path) }}"
    dest: "/home/{{ ssh_tunnel_service_user }}/.ssh/authorized_keys"
    owner: "{{ ssh_tunnel_service_user }}"
    group: "{{ ssh_tunnel_service_user }}"
    mode: '0600'
  when: ssh_tunnel_public_key_path is defined
  become: yes

- name: Install watchdog package if not already installed
  ansible.builtin.apt:
    name: watchdog
    state: present
  when: ansible_os_family == 'Debian'

- import_tasks: ../handlers/main.yml
